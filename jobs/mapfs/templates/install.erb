#!/bin/bash

set -e

echo "Installing fuse"

codename=$(lsb_release -c | awk '{print $2}')
if [ "$codename" == "trusty" ]; then
  (
  flock -x 200
  dpkg  --force-confdef -i /var/vcap/packages/mapfs-fuse/fuse_2.9.2-4ubuntu4.14.04.1_amd64.deb
  ) 200>/var/vcap/data/dpkg.lock
elif [ "$codename" == "xenial" ]; then
  (
  flock -x 200
  dpkg  --force-confdef -i /var/vcap/packages/mapfs-fuse/fuse_2.9.4-1ubuntu3.1_amd64.deb
  ) 200>/var/vcap/data/dpkg.lock
fi

modprobe fuse || true
groupadd fuse || true
adduser vcap fuse
chown root:fuse /dev/fuse
cat << EOF > /etc/fuse.conf
user_allow_other
EOF
chmod 644 /etc/fuse.conf

echo "Installing mapfs"

chown root:vcap /var/vcap/packages/mapfs/bin/mapfs
chmod 750 /var/vcap/packages/mapfs/bin/mapfs
chmod u+s /var/vcap/packages/mapfs/bin/mapfs
