#!/bin/bash -e

TEMP_FILE=$(mktemp)

<%=p("path")%> $@ > "${TEMP_FILE}" &
MAPFS_PID=$!

for i in {1..600}; do
    if grep "Mounted!" "${TEMP_FILE}"; then
      rm "${TEMP_FILE}" || true
      exit 0
    else
      if ps -e | grep "${MAPFS_PID}"; then
        sleep 0.1
      else
        rm "${TEMP_FILE}" || true
        wait "${MAPFS_PID}"
        exit $?
      fi
    fi
done

rm "${TEMP_FILE}" || true
exit 1
